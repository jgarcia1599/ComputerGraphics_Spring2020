<html>

<head>
<script>

window.onload = function() {
    function handleObj(e) { 
		var reader = new FileReader();
		reader.onload = function (ev) {
                jsobj(ev.target.result);
        }
		reader.readAsText(e.target.files[0]);
    }

    var objFile = document.getElementById("objFile");
    objFile.addEventListener('change', handleObj, false);
}

function jsobj(obj) {
    /*
     The arrays v,t, and n are for storing the vertex positions,
     texture coordinates and normal information temporarily.
     Every distinct combination of indices corresponds to a new 
     entry in the arrays used in the model object. Since indices 
     in the obj file start from 1 instead of 0, we put a dummy 
     entry "-1" at position 0 in the arrays v,t and n.
    */

    var v  = [-1];  // vertex position array
    var t  = [-1];  // vertex texture coordinate array
    var n  = [-1];  // vertex normal array
    var m  = {};    // vertex triplet map

    var model = {
        positions : [],
        texCoords : [],
        normals   : [],
        triangles : [],
    };

    function stringify() {
        function stringifyArray(name, a) {
            if (a.length > 0) {
                string += '\t' + name + ' : [\n';
                for (var i = 0; i < a.length; i++) {
                    string += '\t\t['   + a[i].join(', ') +   '],\n';
                }
                string += '\t],\n';
            }
        }

        var string  = '{\n';
        stringifyArray('positions', model.positions);
        stringifyArray('texCoords', model.texCoords);
        stringifyArray('normals',   model.normals);
        stringifyArray('triangles', model.triangles);
        string += '}\n';
        return string;
    }

    function findIndex(f) {

        if (m[f] == undefined) {
            
            m[f] = model.positions.length;

            var a = f.split('/');
            var i = parseFloat(a[0]);
            var j = parseFloat(a[1]);
            var k = parseFloat(a[2]);

            // handle negative references 
            if(i<0){i += v.length; }
            if(j<0){j += t.length; }
            if(k<0){k += n.length; }

            if(i) { model.positions.push(v[i]); }
            if(j) { model.texCoords.push(t[j]); }
            if(k) { model.normals.push(n[k]);   }
        }      
        return m[f];
    }

    function newTriangle(a, b, c) {
       var i = findIndex(a);
       var j = findIndex(b);
       var k = findIndex(c);

       model.triangles.push([i,j,k]);
    }

    var line = obj.split('\n');

    for (var i = 0; i < line.length; i++) {
        token = line[i].trim().split(/\s+/);

        var tag = token[0];
        var t1 = parseFloat(token[1]);
        var t2 = parseFloat(token[2]);
        var t3 = parseFloat(token[3]);

        if (tag == 'v') { v.push([t1,t2,t3]); }
        else if (tag == 'vt') { t.push([t1,t2]); }
        else if (tag == 'vn') { n.push([t1,t2,t3]); }
        else if (tag == 'f') {
            for (var j = 2; j < token.length - 1; j++) {
                newTriangle(token[1], token[j], token[j + 1]); //triangle fan
            }
        }
    }
	
	var output = stringify();
	document.getElementById("outputdiv").innerHTML = 
					"<br><b> JSON Output: </b><br>"
					+ "<textarea readonly rows=\"40\" cols=\"100\">" 
					+ output 
					+ "</textarea><br>"
					+ "<a href=data:text/plain;charset=utf-8,"
					+ encodeURIComponent(output)
					+ " download=Output.json>Download</a>";
}

</script>
<style type='text/css'>
body{
  color:#000000; background-color:#deffed;
  font-family:arial, verdana, sans-serif; font-size:14pt;}

fieldset {
  font-size:18px;
  padding:10px;
  width:750px;
  line-height:1.8;}

label:hover {cursor:hand;}
</style>
</head>

<body>
    <h1>OBJ to JSON</h1>
    <fieldset>
        <label><b> OBJ file:</b></label>
        <input type="file" id="objFile"> <br>
		<div id="outputdiv"> </div>
    </fieldset>
</body>

</html>